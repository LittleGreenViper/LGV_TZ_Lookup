<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LGV_TZ_Lookup: LGV_TZ_Lookup</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">LGV_TZ_Lookup
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">LGV_TZ_Lookup </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2_users_2chrismarshall_2_developer_2_l_g_v_2_l_g_v___t_z___lookup_2_r_e_a_d_m_e"></a> </p><div style="float:right"><a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup"><img src="img/GitHub-Mark-64px.png" alt="" style="width:32px" class="inline"/> </a></div> <div style="float:left"> <img src="img/icon.png" alt="" class="inline"/> </div> <div style="clear:both"></div> <h1>LGV_TZ_Lookup</h1>
<p>Server for Matching Long/Lat to Timezone</p>
<h2>Overview</h2>
<p>This project is a fairly simple PHP project, designed to accept the GeoJSON output of <a href="https://github.com/evansiroky/timezone-boundary-builder">the Timezone Boundary Builder Project</a>, and provide a simple API, for matching longitude/latitude locations with timezones.</p>
<p>Send in a long/lat, and get back a string, with <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">the standard TZ time zone designator</a> of the timezone that covers that point.</p>
<p><a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup">This is the GitHub repo for this project</a></p>
<h2>What Problem Does This Solve?</h2>
<p>Unfortunately, time zones are not a simple "I'm at this longitude, so it must be this time." They are political constructs.</p>
<p>Here's why we can't just do a simple longitude match:</p>
<p><img src="World_Time_Zones_Map.png" alt="" class="inline" title="Time Zones Of the World"/>     <a href="https://commons.wikimedia.org/wiki/File:World_Time_Zones_Map.png"><em>Image Source: Wikimedia Commons</em></a></p>
<p>We address this by using the rendered result of <a href="https://github.com/evansiroky/timezone-boundary-builder">this great project</a>, which is an effort to build a "living document" map of all the world timezones, as a shapefile (a file that can project polygons over a digital map), and locating a geographic point, within those shapes.</p>
<h2>How This Works</h2>
<p>We provide a very basic PHP server that builds a simple database from the data in the massive shapefile (The <a href="https://geojson.org">GeoJSON</a> variant that results from the timezone boundary builder. It can be found in any of <a href="https://github.com/evansiroky/timezone-boundary-builder/releases">the project releases</a>). The database is deliberately "dumb," with a view towards making the project as flexible as possible, and lookups fast and easy.</p>
<p>Each timezone is described in <a href="https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.6">a GeoJSON polygon</a> (or <a href="https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.7">multipolygon</a>).</p>
<blockquote class="doxtable">
<p>&zwj;NOTE: We are making <em>huge</em> assumptions about the file. We assume that the polygons are very basic, "closed" polygons, and that multipolygons are simply aggregations of simple polygons (as opposed to making "holes," and whatnot). </p>
</blockquote>
<p>We build a database of polygons (breaking up multipolygons), with what we term a "domain rect." This is a rectangle that encloses the entire polygon, regardless of the shape of the polygon.</p>
<p>The "domain rect" is used for a fast "triage" lookup. Its vertices are indexed in the database, so comparisons are zippy. We can quickly find the timezones that may contain our location, and ignore the rest.</p>
<p>In some cases, the domain rect "triage" may return only one result, so we got it in one. In other cases, we can then do a simple <a href="https://en.m.wikipedia.org/wiki/Winding_number">"Winding Number"</a> lookup of the location, using the un-indexed polygon data for that timezone, and figure out which polygon actually has it. We return the first one.</p>
<p>From a usage standpoint, you simply send in a longitude/latitude pair, as a simple <a href="https://www.w3schools.com/tags/ref_httpmethods.asp">HTTP GET</a>, and you will receive a "raw" string response, with the <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">TZ</a> name of the timezone that applies to the location.</p>
<p><code>http</code>_[<em>s</em>]_<code>://</code>_&lt;YOUR SERVER URL TO THE src DIRECTORY&gt;[_<code>/index.php</code>_]_<code>?ll=</code>_]&lt;LONGITUDE&gt;,&lt;LATITUDE&gt;_</p>
<p><code><a href="https://tz.example.com?ll=-73.123,44.456">https://tz.example.com?ll=-73.123,44.456</a></code></p>
<p>The long/lat is sent as a comma-separated pair of floating-point numbers that represent degrees of longitude and latitude.</p>
<h2>Dependencies</h2>
<p>This is a server project, designed for your classic <a href="https://en.wikipedia.org/wiki/LAMP_(software_bundle)">"LAMP"</a> hosting, so you'll need to have a standard PHP/MySQL host.</p>
<p>This project uses <a href="https://github.com/salsify/jsonstreamingparser">the streaming JSON parser</a>, in order to parse <a href="https://github.com/evansiroky/timezone-boundary-builder/releases/download/2023b/timezones-with-oceans.geojson.zip">this file</a> (a current release, at the time of this writing), which is <a href="https://geojson.org">a GeoJSON file</a>, containing the calculated timezones, and is created by <a href="https://github.com/evansiroky/timezone-boundary-builder">this project</a>.</p>
<p>Otherwise, it is a very basic <a href="https://php.net">PHP</a> project (tested against <a href="https://www.php.net/releases/8.2/en.php">PHP 8.2</a>, at the time of this writing).</p>
<p>The initial release is built for <a href="https://www.mysql.com">MySQL</a> (tested against <a href="https://downloads.mysql.com/archives/community/">MySQL 5.7</a>), but uses <a href="https://www.php.net/manual/en/book.pdo.php">PHP PDO</a>, and has <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/blob/5cb4aafac824b330c9181a2186ff3c89aac784f6/src/Sources/LGV_TZ_Lookup_Database.class.php#L65">an absurdly simple database schema</a>, so it can be expanded to other databases fairly easily.</p>
<p>Other than a <a href="https://getcomposer.org">Composer</a> link to <a href="https://github.com/salsify/jsonstreamingparser">the streaming JSON parser</a>, there are no other dependencies.</p>
<h3>Batteries Not Included</h3>
<p>Well...that's not <em>strictly</em> true. You'll need to download the GeoJSON file from <a href="https://github.com/evansiroky/timezone-boundary-builder/releases">the Timezone Boundary Builder Project releases</a>. It's a big file, and may be updated, as timezones change. You can use either of the files (with or without oceans), as we ignore the "Etc" timezones, in favor of the named ones.</p>
<h2>Implementation</h2>
<h3>Initial Installation</h3>
<p>Once you have a server available, install the entire directory in the <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/tree/main/src"><code>src</code> subdirectory</a> in a place of your choosing, accessible via HTTP. You should have a URI that points to the <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/blob/main/src/index.php"><code>index.php</code> file</a> in the <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/tree/main/src"><code>src</code> directory</a>.</p>
<h3>Database Setup</h3>
<p>You will need to set up a MySQL database, with a user with basic full permissions.</p>
<h3>Config File</h3>
<p>A requirement for the server is a configuration file. It should generally be placed outside the HTTP-accesible directory tree, and you will need to modify the line in the <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/blob/f9914c89e8484522732100ea82f8b1cab8c667f6/src/index.php#L51"><code>index.php</code></a> file that looks like this:</p>
<p>&lsquo;define("__CONFIG_FILE_", __DIR__.&rsquo;/../../../../TZInfo/config.php');`</p>
<p>To point to the configuration file.</p>
<p>The contents of the configuration file will look like this:</p>
<div class="fragment"><div class="line">&lt;?php </div>
<div class="line">    $g_dbName = &quot;&lt;DATABASE NAME&gt;&quot;;</div>
<div class="line">    $g_dbUserName = &quot;&lt;DATABASE USERNAME&gt;&quot;;</div>
<div class="line">    $g_dbPassword = &quot;&lt;DATABASE USER PASSWORD&gt;&quot;;</div>
<div class="line">    $g_dbType = &quot;&lt;DATABASE TYPE&gt;&quot;;</div>
<div class="line">    $g_dbHost = &quot;&lt;DATABASE HOST&gt;&quot;;</div>
<div class="line">    $g_dbPort = &quot;&lt;DATABASE PORT&gt;&quot;;</div>
<div class="line">    $g_server_secret = &quot;&lt;SERVER SECRET&gt;&quot;;</div>
</div><!-- fragment --><p>with each of the strings changed to match the configuration. Here's an example:</p>
<div class="fragment"><div class="line">&lt;?php </div>
<div class="line">    $g_dbName = &quot;HostingHash_TZDB&quot;;</div>
<div class="line">    $g_dbUserName = &quot;tzUser&quot;;</div>
<div class="line">    $g_dbPassword = &quot;swordfish&quot;;</div>
<div class="line">    $g_dbType = &quot;mysql&quot;;</div>
<div class="line">    $g_dbHost = &quot;127.0.0.1&quot;;</div>
<div class="line">    $g_dbPort = &quot;3306&quot;;</div>
<div class="line">    $g_server_secret = &quot;Shh-Dont-Tell-Anyone&quot;;</div>
</div><!-- fragment --><p>That <code>$g_server_secret</code> is important, if you don't want "just anyone" accessing the server. If it is set to a string, then every call to the server (including the command line) will need to have a <code>secret=&lt;SERVER SECRET&gt;</code> query argument added to the regular query, like so:</p>
<h4>HTTP Request:</h4>
<p><code><a href="https://tz.example.com/index.php?secret=Shh-Dont-Tell-Anyone">https://tz.example.com/index.php?secret=Shh-Dont-Tell-Anyone</a>&amp;ll=-73.123,44.456</code></p>
<h4>Command Line:</h4>
<p><code>?&gt; php</code>_&lt;PATH TO THE src DIRECTORY&gt;_<code>/index.php secret=Shh-Dont-Tell-Anyone load</code></p>
<h3>Composer</h3>
<p>Once the directory is in place, you'll need to update composer, to bring in the dependency.</p>
<div class="fragment"><div class="line"> (bash)</div>
<div class="line">$&gt; cd &lt;YOUR src DIRECTORY&gt;</div>
<div class="line">$&gt; composer update</div>
</div><!-- fragment --><p>That will set up a <code>vendor</code> subdirectory. Just ignore it, after that. The server knows where to get it.</p>
<p>&gt;NOTE: The dependency is only required for the load and setup. It is not required for subsequent queries.</p>
<h3>The Data File</h3>
<p>You'll need to fetch the GeoJSON data file from <a href="https://github.com/evansiroky/timezone-boundary-builder/releases">the Boundary Builder Project Releases Directory</a>. Get the latest release, and look for files named <code>timezones.geojson.zip</code>, or <code>timezones-with-oceans.geojson.zip</code>.</p>
<p>They are pretty big files.</p>
<p>Unzip the file into the <code>src</code> directory.</p>
<p>&gt;NOTE: We have the project initially set up for the <code>combined-with-oceans.json</code> file. If you want to use the <code>combined.json</code> file, instead, then you should edit the <a href="https://github.com/LittleGreenViper/LGV_TZ_Lookup/blob/f9914c89e8484522732100ea82f8b1cab8c667f6/src/index.php#LL113C14-L113C14"><code>index.php</code></a> file at the line that looks like this:</p>
<div class="fragment"><div class="line">(php)</div>
<div class="line">   $stream = fopen(&quot;$path/combined-with-oceans.json&quot;, &#39;r&#39;);</div>
</div><!-- fragment --><p>so that it looks like this:</p>
<div class="fragment"><div class="line">(php)</div>
<div class="line">   $stream = fopen(&quot;$path/combined.json&quot;, &#39;r&#39;);</div>
</div><!-- fragment --><p>&gt;CAUTION: If you do this, some of the tests won't pass!</p>
<h3>The Initial Load and Database Setup</h3>
<p>You don't need to "prime" the database. The server will take care of creating the table.</p>
<p>However, the initial load can only be done via command-line, so you'll need to SSH into the server, and run the load from there. You use the syntax indicated above:</p>
<div class="fragment"><div class="line"> (bash)</div>
<div class="line">$&gt; php &lt;YOUR src DIRECTORY&gt;/index.php server=&lt;SERVER SECRET&gt; load</div>
</div><!-- fragment --><p>This can take a while.</p>
<p>Upon success, the script emits a simple <code>1</code>. If there was a problem, it emits a <code>0</code>.</p>
<p>Once that's done. the server is ready to go. You can even delete the JSON file and the vendor directory, if you want, but they will need to be back, before you can load.</p>
<p>You won't need to run <code>load</code> very often, so it shouldn't be in a <code>cron</code> job, or anything.</p>
<p>All interactions from then on, are done via HTTP.</p>
<h3>Testing</h3>
<p>We have a set of simple tests that can be run. They send in known coordinates, and ensure that the server returns the proper response.</p>
<p>You run the tests, like so:</p>
<p><code><a href="https://tz.example.com">https://tz.example.com</a></code>_[_<code>/index.php</code>_]_<code>?</code>_[_<code>secret=&lt;SERVER SECRET&gt;&amp;</code>_]_<code>test</code></p>
<p>You will get a simple HTML page, with each of the tests, listed. If the test passes, the title will be green. If it fails, the title will be red, and there will be a list of links to failures, at the top of the page.</p>
<p>Everything should be green (unless you swapped out the JSON file, in which case, you'll need to look for the failures, and validate the tests).</p>
<h2>License</h2>
<p>This is an <a href="https://opensource.org/license/mit/">MIT-Licensed</a> project. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
